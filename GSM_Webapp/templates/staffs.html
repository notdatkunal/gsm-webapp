{% extends "index.html" %}
{% load static %}
{% block css %}
    <title>Staff</title>
{% endblock css %}
{% block content %}
<div class="student_head">
    <div>
        <p class="heading__primary heading__primary--animation">Staff Management</p>
    </div>
    <div>
        <button class="btn btn--create" onclick="openForm()">
            Register New Staff
        </button>
        <!-- Export Button -->
        <button class="btn btn--export">
            <i class="fa-solid fa-download"></i> Export
        </button>
    </div>
</div>
<section class="form-section">
    <div class="main-header">
        <h1 class="header-form">Staff Registration Form</h1>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>
    <div class="container">
        <form id="staff-form" name="form" class="form" action="#" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="id" id="id">
            <div class="accordion">
                <!-- Basic Details Section -->
                <div class="list">
                    <input type="checkbox" name="accordion" id="first" class="check_accord" checked>
                    <label for="first" class="details" id="label1">Basic Details</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Full Name <span>*</span></label>
                                <input type="text" class="form-input" name="staff_name" id="staff_name"
                                    placeholder="Enter your Full Name" >
                            </div>
                            <div class="input-field">
                                <label class="labels">Designation</label>
                                <input type="text" placeholder="Enter Designation" name="role" id="role" class="form-input" >
                            </div>

                        </div>
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Joining Date <span>*</span></label>
                                <input type="date" class="form-input" name="joining_date" id="joining_date">
                            </div>
                            <div class="input-field">
                                <label class="labels">Date Of Birth</label>
                                <input type="date" class="form-input" name="date_of_birth" id="date_of_birth">
                            </div>
                        </div>
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Gender</label>
                                <select class="gender-list" name="gender" id="gender">
                                    <option selected>Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="input-field">
                                <label class="labels">Blood Group</label>
                                <select class="gender-list" name="blood_group" id="blood_group">
                                    <option selected>Select Blood Group</option>
                                    <option value="O+">O+</option>
                                    <option value="A+">A+</option>
                                    <option value="B+">B+</option>
                                    <option value="AB+">AB+</option>
                                    <option value="O-">O-</option>
                                    <option value="A-">A-</option>
                                    <option value="B-">B-</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                        </div>
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Photo <span>*</span></label>
                                <input type="file" class="form-input" accept="image/jpeg,image/jpg" name="photo" id="photo">
                            </div>
                            <div class="input-field">
                            </div>
                            <p class="file-info" style="margin-left:0;">(Maximum size for photo is 500 kb.)</p>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <input type="checkbox" name="accordion" id="second" class="check_accord">
                    <label for="second" class="details" id="label1">Contact Details</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Mobile No <span></span></label>
                                <input type="text" class="form-input" 
                                    maxlength="10" minlength="10" placeholder="Enter valid Number" name="phone_number" id="phone_number">
                            </div>
                            <div class="input-field">
                                <label class="labels">Email Id</label>
                                <input type="email" class="form-input" name="email" id="email"
                                    placeholder="Enter Email Address">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <input type="checkbox" name="accordion" id="third" class="check_accord">
                    <label for="third" class="details" id="label1">Professional Details</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Specialization</label>
                                <input type="text" class="form-input"  placeholder="Where You Specialize" name="specialization" id="specialization" >
                            </div>
                            <div class="input-field">
                                <label class="labels">Experience</label>
                                <input type="text" class="form-input"  placeholder="Write Your Experience" name="experience" id="experience">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <input type="checkbox" name="accordion" id="fourth" class="check_accord">
                    <label for="fourth" class="details" id="label1">Payroll Details</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label for="id">Employment Type<span style="color: red;">*</span></label>
                                <select class="gender-list" name="payroll_type" id="payroll_type">
                                  <option>Full Time</option>
                                  <option>Part Time</option>
                                  <option>Trainee</option>
                                  <option>Full Time</option>
                                  <option>Part Time</option>
                                </select>
                            </div>
                            <div class="input-field">
                                <label class="labels">Salary Amount</label>
                                <input type="text" class="form-input"  placeholder="Enter Salary Amount" id="salary" name="salary">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list">
                    <input type="checkbox" name="accordion" id="fifth" class="check_accord">
                    <label for="fifth" class="details" id="label1">Address Details</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Address Line <span>*</span></label>
                                <input type="text" class="form-input" name="address"
                                    id="address" placeholder="Enter Address" >
                            </div>
                        </div>
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">City <span>*</span></label>
                                <input type="text" class="form-input" name="student_city" id="student_city"
                                    placeholder="Enter City" >
                            </div>
                            <div class="input-field">
                                <label class="labels">State <span>*</span></label>
                                <select name="student_state" id="student_state"  class="gender-list">
                                    <option value="AP">Andhra Pradesh</option>
                                    <option value="TS">Telangana</option>
                                    <option value="MH">Maharashtra</option>
                                    <option value="DL">Delhi</option>
                                    <option value="HP">Himachal Pradesh</option>
                                </select>
                            </div>
                        </div>
                        <div class="fields">
                            <div class="input-field">
                                <label class="labels">Country <span>*</span></label>
                                <input type="text" class="form-input" placeholder="Enter Country" type="text"
                                    placeholder="Enter Country" name="student_country" id="student_country" >
                            </div>
                            <div class="input-field">
                                <label class="labels"> Pincode<span>*</span></label>
                                <input type="text" class="form-input" name="student_pincode" id="student_pincode"
                                    placeholder="Enter Pincode" >
                            </div>
                        </div>
                    </div>
                </div>
 
                {% comment %} <div class="list">
                    <input type="checkbox" name="accordion" id="six" class="check_accord">
                    <label for="six" class="details" id="label1">Transportation</label>
                    <div class="contents">
                        <div class="fields">
                            <div class="input-field">
                                <label class="form-label">Route Name</label>
                                <select name="transport_id" id="transport_id" class="gender-list">
                                    <option>Gachibowli</option>
                                    <option>Gachibowli</option>
                                    <option>Gachibowli</option>
                                    <option>Gachibowli</option>
                                    <option>Gachibowli</option>
                                </select>
                            </div>
                            <div class="input-field">
                                <label class="labels">Pickup Point</label>
                                <input type="text" class="form-input">
                            </div>
                        </div>
                    </div>
                </div> {% endcomment %}

            </div>

            <div class="sticky">
                <a onclick="closeNav()" class="btn btn--cancel"><label>Cancel</label> </a>
                <button class="btn btn--save" type="submit">Save</button>
            </div>
        </form>
    </div>
</section>

<script>
    // Function to close the form section
    function closeNav() {
        console.log("done");
        document.querySelector(".form-section").classList.remove("form-show");
    }

    // Function to open the form section
    function openForm() {
        document.querySelector(".form-section").classList.add("form-show");
    }
</script>

<div>
    <table class="tbl">
        <th>Photo</th>
        <th>Staff Name</th>
        <th>Role</th>
        <th>Specialization</th>
        <th>Contact Number</th>
        <th>Date Of Joining</th>
        <th>Gender</th>
        <th>Blood Group</th>
        <th>Action</th>

        <tbody class="tbl__bdy">
            {% for staff in staff_data %}
            <tr class="tr-staff-{{staff.staff_id}}">
                <td>{{forloop.counter}}</td>
                <td class="staff_name">{{ staff.staff_name }}</td>
                <td class="role">{{ staff.role }}</td>
                <td class="specialization">{{ staff.specialization }}</td>
                <td class="phone_number">{{ staff.phone_number }}</td>
                <td class="joining_date">{{ staff.joining_date }}</td>
                <td class="gender">{{ staff.gender }}</td>
                <td class="blood_group">{{ staff.blood_group }}</td>
                <td>
                    <a href="#" onclick="EditButton(this)" data-id="{{staff.staff_id}}">
                        <i class="fa-sharp fa-solid fa-pen"></i>
                    </a>
                    <a href="#" onclick="DeleteButton(this)" data-id="{{staff.staff_id}}">
                        <i class="fa-solid fa-trash"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>

    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

// Create & Update For student
let isEditMode = false;

document.getElementById('staff-form').addEventListener('submit', function (event) {
    event.preventDefault();

    console.log("inside jss")
    const formData = new FormData(document.getElementById('staff-form'));
    const staffData = {
        "institute_id": 1,
        "staff_id": formData.get("id"),
        "employee_id": 10101,
        "staff_name": formData.get("staff_name"),
        "photo": "url",
        "role": formData.get("role"),
        "address": formData.get("address"),
        "gender": formData.get("gender"),
        "experience": formData.get("experience"),
        "specialization": formData.get("specialization"),
        "phone_number": formData.get("phone_number"),
        "email": formData.get("email"),
        "blood_group": formData.get("blood_group"),
        "date_of_birth": formData.get("date_of_birth"),
        "joining_date": formData.get("joining_date"),
        "salary": formData.get("salary"),
        "slug": "Sai-6",
        "is_deleted": false,
        "transport_id": 11,
    }
    console.log("formData", staffData);

    const url = isEditMode ? `{{ URL }}StaffS/update_staff/?staff_id=${staffData.staff_id}` : '{{ URL }}StaffS/create_staff/';
    const method = isEditMode ? 'PUT' : 'POST';
    console.log("url", url)
    console.log("method", method)
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(staffData),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return response.json();
    })
    .then(createdStaffData => {
        // For Student & Parent Updating Details
        if (isEditMode) {
            const updatedPayroll = {
                            "staff_id": formData.get("id"),
                            "payroll_type": formData.get("payroll_type"),
                            "salary_amount": formData.get("salary"),
                            "payment_date": "2023-12-13",
                            "payment_mode": "string",
                            "payroll_details": "string"
                        };
            fetch(`{{ URL }}StaffPayrole/update_payroll/?staff_id=${staffData.staff_id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedPayroll),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(updatedPayrollResponse => {
                console.log('Updated Payroll Data:', updatedPayrollResponse);
                
                const updateData = createdStaffData["response"];
                console.log("updateData",updateData);
                
                const tr = document.querySelector(`.tr-staff-${updateData["staff_id"]}`);
                
                console.log("tr",updateData["staff_id"]);

                Swal.fire({
                    icon: 'success',
                    title: 'Staff Updated Successfully!',
                    position: 'top-end',
                    toast: true,
                    showConfirmButton: false,
                    timer: 3000,
                    padding: '1rem',
                    customClass: {
                        title: 'small-title',
                    },
                });
                for (const key in updateData) {
                    try {
                        tr.querySelector(`.${key}`).textContent = updateData[key];
                        closeNav();
                        document.getElementById('staff-form').reset();
                    } catch (error) {
                        // Handle error if any
                    }
                }
                closeNav();
                document.getElementById('staff-form').reset();
                // isEditMode = true;

                
            })
            .catch(error => {
                console.error('Error updating parent:', error);
            });
        }
            else {
                console.log("staffs data Successful");
                console.log('Response from creating staff:', createdStaffData);

                const response = createdStaffData.response; 
                console.log("response",response);
                const tableBody = document.querySelector('.tbl__bdy');
                // const newRow = document.createElement('tr');
                
                
                
                newRow = `
                <tr class="tr-staff-${response.staff_id}">
                    <td>${tableBody.children.length + 1}</td>
                    <td class="staff_name">${response.staff_name}</td>
                    <td class="role">${response.role}</td>
                    <td class="specialization">${response.specialization}</td>
                    <td> class="phone_number">${response.phone_number}</td>
                    <td class="joining_date">${response.joining_date}</td>
                    <td class="gender">${response.gender}</td>
                    <td class="blood_group">${response.blood_group}</td>
                    <td>
                        <a href="#" onclick="EditButton(this)" data-id="${response.staff_id}">
                            <i class="fa-sharp fa-solid fa-pen"></i>
                        </a>
                        <a href="#" onclick="DeleteButton(this)" data-id="${response.staff_id}">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </td>
                
                </tr>
                `;
                tableBody.innerHTML += newRow;
                
                
        
                    //  Staff Payroll
                    const createdStaffId = createdStaffData.response.staff_id;
                    console.log('Created Staff ID:', createdStaffId);

                        
                        const payrollData = {
                            "staff_id": createdStaffId,
                            "payroll_type": formData.get("payroll_type"),
                            "salary_amount": formData.get("salary"),
                            "payment_date": "2023-12-13",
                            "payment_mode": "string",
                            "payroll_details": "string"
                        };
                        Swal.fire({
                    icon: 'success',
                    title: 'Staff Created Successfully!',
                    position: 'top-end',
                    toast: true,
                    showConfirmButton: false,
                    timer: 3000,
                    padding: '1rem',
                    customClass: {
                        title: 'small-title',
                    },
                });
                        console.log("Payroll data",payrollData);
                        // Make POST request to create a parent associated with the student
                        fetch('{{ URL }}StaffPayrole/add_payroll/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payrollData),
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok.');
                            }
                            return response.json();
                        })
                        .then(createdPayrollData => {
                            console.log('Created Payroll Data:', createdPayrollData);
                            // Further handling of created parent data

                            
                            })
                        .catch(error => {
                            console.error('Error creating Payroll:', error);
                        });
                        isEditMode = false;
                
                
                closeNav();
                document.getElementById('staff-form').reset();
                
            
            }

                    
                
    })
        .catch(error => {
            console.error('Error creating student:', error);
            
        });
});



function EditButton(element) {
    event.preventDefault();

    console.log("inside edit button");

    const id = element.getAttribute('data-id');
    console.log("each id", id)

    const staffUrl = `{{ URL }}StaffS/get_staff_by_id/?staff_id=${id}`;

    fetch(staffUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
        .then(data => {
            console.log('Staff Data received from API:', data);
            openForm('registration');
            const staffResponse = data["response"];

            
            document.getElementById("id").value = staffResponse.staff_id;
            document.getElementById("staff_name").value = staffResponse.staff_name;
            document.getElementById("role").value = staffResponse.role;
            document.getElementById("address").value = staffResponse.address;
            document.getElementById("gender").value = staffResponse.gender;
            document.getElementById("experience").value = staffResponse.experience;
            document.getElementById("specialization").value = staffResponse.specialization;
            document.getElementById("phone_number").value = staffResponse.phone_number;
            document.getElementById("email").value = staffResponse.email;
            document.getElementById("blood_group").value = staffResponse.blood_group;
            document.getElementById("date_of_birth").value = staffResponse.date_of_birth;
            document.getElementById("joining_date").value = staffResponse.joining_date;
            document.getElementById("salary").value = staffResponse.salary;


            const staff_id = staffResponse.staff_id; 
            console.log("staff_id",staff_id);
            const payrollUrl = `{{ URL }}StaffPayrole/get_payroll_data/?staff_id=${staff_id}`;

            
            fetch(payrollUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(payrollResponse => {
                    if (!payrollResponse.ok) {
                        throw new Error('Network response for parent was not ok.');
                    }
                    return payrollResponse.json();
                })
                .then(payrollData => {
                    console.log('Payroll Data received from API:', payrollData);
                    const payrollResponse = payrollData["response"];

                    
                    document.getElementById("salary").value = payrollResponse.salary_amount;
                    document.getElementById("payroll_type").value = payrollResponse.payroll_type;
                    
                    
                })
                .catch(payrollError => {
                    console.log('Fetch error for payroll:', payrollError);
                });

            isEditMode = true;
        })
        .catch(error => {
            console.log('Fetch error for staff:', error);
        });
}







function DeleteButton(element){
    Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to delete this student data.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
        event.preventDefault();
   
        console.log("inside Delete button");
       
        const id = element.getAttribute('data-id');
        console.log(" each id", id)
        const url = `{{ URL }}StaffS/delete_staff/?staff_id=${id}`;
 
        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
        .then(data => {
            console.log('Data Deleted from API:', data);
           
            const DeleteRow = document.querySelector(`.tr-staff-${id}`);
            if (DeleteRow) {
                DeleteRow.remove();
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: 'Staff data deleted Successfully',
                });
            } else {
                console.log('Row not found in the table');
            }
       
           
        })
        .catch(error => {
            console.log('Fetch error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong while deleting.',
            });
        });
    }
});
    };
</script>
{% endblock %}