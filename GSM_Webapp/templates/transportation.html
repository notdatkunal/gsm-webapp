{% extends "index.html" %}
{% block content %}

<!-- SweetAlert CDN -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <div class="student_head">
    <div>
        <p class="heading__primary heading__primary--animation">Transportation</p>
    </div>
    <div>
        <button class="btn btn--create" onclick="openForm('registration')">Register Vehcile </button>
    </div>
</div>
<section class="form-section registration">
    <div class="main-header">
        <h1 class="header-form">Register Vechile</h1>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav('registration')">&times;</a>
    </div>
    <div class="container">
        <form id="transport-form" class="form" name="form" id="form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="id" id="id">
            <div class="contents" id="form-field">
                <div class="fields">
                    <div class="input-field">
                        <label class="labels">vechile number <span style="color: red;">*</span></label>
                        <input type="text" class="form-input" id="vehicle_number" name="vehicle_number"
                            placeholder="vechile number">
                    </div>
                </div>
                <div class="fields">
                    <div class="input-field">
                        <label class="labels">vechile Details <span style="color: red;">*</span></label>
                        <textarea class="text-field" id="vehicle_details" name="vehicle_details" rows="5"
                            placeholder="Enter Description"></textarea>
                    </div>
                </div>
                <div class="fields">
                    <div class="input-field">
                        <label class="labels">datr of Registation<span style="color: red;">*</span></label>
                        <input type="date" class="form-input" name="register_date" id="register_date">
                    </div>
                </div>
                <div class="fields">
                    <div class="input-field">
                        <label class="label">transport_name<span style="color: red;">*</span></label>
                        <input type="text" class="form-input" name="transport_name" id="transport_name"
                            placeholder="transport name" required>
                    </div>
                </div>
            </div>
            <div class="sticky">
                <a onclick="closeNav('registration')" class="btn btn--cancel"><span>Cancel</span></a>
                <button type="submit" class="btn btn--save"><span>Save</span></button>
            </div>
        </form>
    </div>
</section>



<script>
    // Function to close the form section side nav
    function closeNav(formClass) {
        console.log("done");
        document.querySelector("." + formClass).classList.remove("form-show");
    }

    // Function to open the form section side nav
    function openForm(formClass) {
        document.querySelector("." + formClass).classList.add("form-show");
    }
    function openstopDetails(formClass, transportName) {
    console.log("Transport Name:", transportName);
    document.querySelector("." + formClass).classList.add("form-show");
    document.getElementById("transportNameContent").innerHTML = `<h1>${transportName}</h1>`;
   }
    function closestopDetails(formClass) {
        console.log("done");
        document.querySelector("." + formClass).classList.remove("form-show");
    }

    function closestudentDetails(formClass) {
        console.log("done");
        document.querySelector("." + formClass).classList.remove("form-show");
    }

    // Function to open student 
    function openstudentDetails(formClass) {
        document.querySelector("." + formClass).classList.add("form-show");
    }
    openstaffDetails
    function closestaffDetails(formClass) {
        console.log("done");
        document.querySelector("." + formClass).classList.remove("form-show");
    }

    // Function to open the form staff
    function openstaffDetails(formClass) {
        document.querySelector("." + formClass).classList.add("form-show");
    }

</script>

<table class="tbl">
    <thead>
        <tr>
            <th>S.NO</th>
            <th>Vehicle Number</th>
            <th>Vehicle Details</th>
            <th>Date of Register</th>
            <th>transport name</th>
            <th>Stoppage</th>
            <th>Students</th>
            <th>Staffs</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody class="tbl__bdy" id="transport_details">
        {% for transport in transportation %}
        <tr class="tr-transport-{{transport.transport_id}}">
            <td>{{forloop.counter}}</td>
            <td class="vehicle_number ">{{transport.vehicle_number}}</td>
            <td class="vehicle_details">{{transport.vehicle_details}}</td>
            <td class="register_date">{{transport.register_date}}</td>
            <td class="transport_name">{{transport.transport_name}}</td>
            <td>
                <button class="btn-view openBtn" data-id="{{transport.transport_id}}" onclick="openstopDetails('stopages', '{{ transport.transport_name }}')">View</button>
            </td>
            <td>
                <button class="btn-view openBtn" onclick="openstudentDetails('student')">View</button>
            </td>
            <td>
                <button class="btn-view openBtn" onclick="openstaffDetails('staff')">View</button>
            </td>
            <td>
                <a href="#" onclick="EditButton(this)" data-id="{{transport.transport_id}}">
                    <i class="fa-sharp fa-solid fa-pen"></i>
                </a>
                <a href="#" onclick="DeleteButton(this)" data-id="{{transport.transport_id}}">
                    <i class="fa-solid fa-trash"></i>
                </a>

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- stopages form code  -->

<section class="form-section stopages">
    <div class="main-header">
        <h1 class="header-form"> Stoppage in this Route</h1>
        <a href="javascript:void(0)" class="closebtn" onclick="closestopDetails('stopages')">&times;</a>
    </div>
    <div class="contents" id="transportNameContent"></div>
    <div class="accordion">
        <div class="list">

            <input type="checkbox" name="accordion" id="stopage_id" class="check_accord" checked>
            <label for="first" class="details" id="label1">Add stopages</label>
                <div class="fields">
                    <input type="hidden" name="stopage_id" id="stopage_id">
                    <div class="input-field">
                        <input type="text" class="form-input"  id="stopage" placeholder="Add stopage">
                        <button type="button"  id="add-stopage"  data-id="{{transport.transport_id}}" onclick="addMore()">
                        <i class="fa-solid fa-check" id="add-stopage"></i>
                        </button>
                    </div>
                </div>
                <div id="stopagesList">
                </div>
        </div>
        </div>
        
</section>
<!-- student form views -->

<section class="form-section student">
    <div class="main-header">
        <h1 class="header-form">Add Students To Vehicle</h1>
        <a href="javascript:void(0)" class="closebtn" onclick="closestudentDetails('student')">&times;</a>
    </div>
    <form class="form" id="student-form">
        <div class="input-field">
            <input type="text" class="form-input" placeholder="Enter student number"  id="roll_number">
            <input type="hidden" id="transportPk" name="transportPk">
            <input type="submit" class="btnAssign" id="btnAssign" value="Assign">
        </div>
    </form>
    <table class="tbl">
        <thead>
            <tr>
                <th>Student Number</th>
                <th>Student Name</th>
            </tr>
        </thead>
        <tbody id="assignedStudents" class="tbl__bdy">
            <!-- This is where the assigned students will be displayed -->
        </tbody>
    </table>
</section>
<!-- staff form -->

<section class="form-section staff">
    <div class="main-header">
        <h1 class="header-form">Add Staff To Vehicle</h1>
        <a href="javascript:void(0)" class="closebtn" onclick="closestaffDetails('staff')">&times;</a>
    </div>
    <form class="form">
        <div class="input-field">
            <input type="text" class="form-input" placeholder="Enter staff Name">
            <input type="hidden" id="transportPk" name="transportPk">
            <input type="button" class="btnAssign" id="btnAssign" value="Assign">
        </div>
    </form>
    <div>
        <h2>Assigned Staffs</h2>
    </div>
    <table class="tbl">
        <thead>
            <tr>
                <th>Staff ID</th>
                <th>Staff Name</th>
            </tr>
            <tr>
                <thead>
                <tbody class="tbl__bdy"></tbody>
        </thead>
        </tr>
    </table>
    </div>

</section>
<script>
    let isEditMode = false;
    // create and Edit save  javascript code
    document.getElementById('transport-form').addEventListener('submit', function (event) {
        event.preventDefault();
        console.log("inside");
        const formData = new FormData(document.getElementById('transport-form'));
        const data = {
            "institute_id": 1,
            "id": formData.get("id"),
            "vehicle_number": formData.get("vehicle_number"),
            "vehicle_details": formData.get("vehicle_details"),
            "register_date": formData.get('register_date'),
            "transport_name": formData.get("transport_name"),
        };
        console.log("data from form:", data)
        console.log("created updated check id ", data.id)
        const url = isEditMode ? `{{ URL }}/Transport/update_transport/?transport_id=${data.id}` : `{{ URL }}/Transport/create_transport/`;
        const method = isEditMode ? 'PUT' : 'POST'
        console.log(method, "ok")
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok")
                }
                return response.json();
            })
            .then(data => {
                if (isEditMode) {
                    console.log("inside")
                    const updatedData = data['response']
                    console.log(updatedData, "updatekiii")
                    const tr = document.querySelector(`.tr-transport-${updatedData["transport_id"]}`)
                    console.log(tr)
                    for (const key in updatedData) {
                        try {
                            tr.querySelector(`.${key}`).textContent = updatedData[key]
                            closeNav('registration');
                            document.getElementById('transport-form').reset();
                        }
                        catch {

                        }
                    }
                    Swal.fire({
                icon: 'success',
                title: 'transport updated Successfully!',
                position: 'top-end',
                toast: true,
                showConfirmButton: false,
                timer: 3000,
                padding: '1rem',
                customClass: {
                    title: 'small-title',
                },
            })
                }
                else {
                    const tableBody = document.querySelector('.tbl__bdy');
                    const newRow = document.createElement('tr');
                    console.log("data", data)
                    const response = data["response"]
                    console.log("response", response)

                    newRow.innerHTML = `
                    <td>${tableBody.children.length + 1}</td>
                    <td>${response.vehicle_number}</td>
                    <td>${response.vehicle_details}</td>
                    <td>${response.register_date}</td>
                    <td>${response.transport_name}</td>
                    <td>
                    <button class="btn-view openBtn" onclick="openstopDetails('stopages')">View</button>
                    </td>
                    <td>
                        <button class="btn-view openBtn" onclick="openstudentDetails('student')">View</button>
                    </td>
                    <td>
                        <button class="btn-view openBtn" onclick="openstaffDetails('staff')">View</button>
                    </td>
                    <td>
                        <a href="#" onclick="EditButton(this)" data-id="${response.transport_id}">
                            <i class="fa-sharp fa-solid fa-pen"></i>
                        </a>
                        <a href="#" onclick="DeleteButton(this)" data-id="${response.transport_id}">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </td>
                `;

                    tableBody.appendChild(newRow);
                    Swal.fire({
                icon: 'success',
                title: 'transport added successfully!',
                position: 'top-end',
                toast: true,
                showConfirmButton: false,
                timer: 3000,
                padding: '1rem',
                customClass: {
                    title: 'small-title',
                },
            });
                    closeNav('registration');
                    document.getElementById('transport-form').reset();
                    isEditMode = false;
                }
            })
            .catch(error => {
                console.log('Upgrade error:', error);

            });
    });





    // click on edit form is open  javascript code for transpotation
    function EditButton(element) {
        event.preventDefault();

        console.log("inside edit button");

        const id = element.getAttribute('data-id');
        console.log(" each id", id)
        const url = `{{ URL }}/Transport/get_transport_data_by_id/?transport_id=${id}`;

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                console.log('Data received from API:', data);
                openForm('registration');
                response = data["response"]

                document.getElementById("id").value = response.transport_id;
                document.getElementById("vehicle_number").value = response.vehicle_number;
                document.getElementById("vehicle_details").value = response.vehicle_details;
                document.getElementById("register_date").value = response.register_date;
                document.getElementById("transport_name").value = response.transport_name;
                isEditMode = true;
            })
            .catch(error => {
                console.log('Fetch error:', error);
            });
    }


    // delete javascript code for transpotation

    function DeleteButton(element) {
    event.preventDefault();
    Swal.fire({
            title: 'Are you sure you want to delete this transpotation?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            // User clicked the confirm button
            const id = element.getAttribute('data-id');
            console.log(" each id", id)
            const url = `{{ URL }}/Transport/delete_transport/?transport_id=${id}`;

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data Deleted from API:', data);

                    const DeleteRow = document.querySelector(`.tr-transport-${id}`);
                    if (DeleteRow) {
                        DeleteRow.remove();
                    } else {
                        console.log('Row not found in the table');
                    }
                    Swal.fire({
                                position: 'top-end',
                                icon: 'success',
                                title: 'transport Deleted Successfully',
                                toast: true,
                                showConfirmButton: false,
                                timer: 4000,
                                timerProgressBar: true,
                                customClass: {
                                    popup: 'small-sweetalert',
                                    title: 'small-sweetalert-title',
                                    content: 'small-sweetalert-content'
                                }
                            });

                    isEditMode = true;
                })
                .catch(error => {
                    console.log('Fetch error:', error);
                });
        }
    });
}

</script>


<!-- stopages code -->
<script>


// Function to fetch and display stopages
function displayStopages() {
    const transport_id = 11;
    fetch(`{{URL}}/Stops/get_all_stopages_by_transport/?transport_id=${transport_id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        })
        .then(data => {
            const stoppageContainer = document.getElementById('stopagesList');

            // Clear existing content in the stopageContainer
            stoppageContainer.innerHTML = '';

            // Loop through the data and create elements for each stopage
            data.forEach(stopdata => {
                const stoppageItem = document.createElement('div');
                stoppageItem.id = `stopage_id_${stopdata["stop_id"]}`;

                var space = document.createElement('span');
                space.innerHTML = '&nbsp;&nbsp;';
                stoppageItem.appendChild(space);

                var input = document.createElement('input');
                input.type = 'text';
                input.name = 'stop_name';
                input.placeholder = 'Enter Stops';
                input.className = 'input-field';
                input.value = stopdata["stop_name"];
                input.readOnly = true;
                stoppageItem.appendChild(input);

                // var editButton = document.createElement('button');
                // editButton.type = 'button';
                // editButton.innerHTML = `<a href="#" onclick="Editstopage(this)" datastop-id="${stopdata["stop_id"]}"><i class="fa-solid fa-pen-to-square style=" color: blue;"></i></a>`;
                // editButton.className = 'editButton';
                // var space = document.createElement('span');
                // space.innerHTML = '&nbsp;&nbsp;';
                // stoppageItem.appendChild(space);
                // stoppageItem.appendChild(editButton);

                var deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.innerHTML = `<a href="#" onclick="deleteStoppage(this)" datastop-id="${stopdata["stop_id"]}"><i class="fa-regular fa-trash-can" style="color: red;"></i> </a>`;
                deleteButton.className = 'deleteButton';
                var space = document.createElement('span');
                space.innerHTML = '&nbsp;&nbsp;';
                stoppageItem.appendChild(space);
                stoppageItem.appendChild(deleteButton);

                stoppageContainer.appendChild(stoppageItem);
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Call the function to display stopages on page load
displayStopages();

function Editstopage(element){
    event.preventDefault();
    console.log("inside stopage edit button");
    const id=element.getAttribute("datastop-id");
    // console.log("stopage id",id)
    const url=`{{URL}}/Stops/get_all_stopages_by_transport/?transport_id=${id}`;
    fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
    .then(data => {
        console.log("Stoppage data for editing:", data);
        stops = data["response"];
        console.log("stops",stops)
        document.getElementById('stopage_id').value=stops.stop_id;
        document.getElementById('stop_name').value=stops.stop_name;
    })
    .catch(error=>{
        console.log('Fech error:',error)
    })
}

function deleteStoppage(element) {
    event.preventDefault()
    console.log("deleted")
    const id=element.getAttribute('datastop-id');
    console.log("each id",id)
    const url=`{{ URL }}/Stops/delete_stop/?stop_id=${id}`;


    fetch(url, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then(data => {
        console.log("Stoppage deleted successfully:", data);
        const DeletedStopage=document.querySelector(`#stopage_id_${id}`);
        console.log("id",DeletedStopage)
        if (DeletedStopage){
            DeletedStopage.remove();
        }
        else{
            console.log("stopage row not deleted ")
        }

    })
    .catch(error => {
        console.error('Error:', error);
    });
}


function addMore() {
    const stopageInput = document.getElementById('stopage');
    const stopageName = stopageInput.value.trim();
    console.log("stopage", stopageName);
    const stop = document.getElementById('stopage');

    if (stopageName !== '') {
        const transport_id = 11;
        const requestBody = {
            stop_name: stopageName,
            transport_id: transport_id,
        };

        fetch('{{ URL }}/Stops/create_stopage/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                console.log("data", data);
                // Call the displayStopages function to refresh the stopages list
                displayStopages();
                stop.value = "";
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else {
        alert('Please enter a stoppage name.');
    }
}



</script>



{% endblock %}